<!doctype html>
<html>
<head>
	<title>DUBSTEP JukeBox Demo</title>
    <meta charset="utf-8" />

	<script src="../../src/JukeBox.js"></script>

	<style>

	tr {
		border-bottom: 1px dotted #000;
	}
	input {
		width: 2em;
	}

	</style>
</head>
<body>

<h3>DUBSTEP HIT MAKER</h3>
<span>Extended Coolness For the Internet Version</span>
<br>
<span><a href="http://www.musicradar.com/news/tech/free-music-samples-download-loops-hits-and-multis-217833/79">Used these dubstep sound samples</a></span>
<br>
<br>

<button onclick="Sequencer.play()">Play</button>
<button onclick="GenerateAHitDude()">Generate A Hit, Dude!</button>
<hr>

<table id="timeline"></table>


<script>


var GenerateAHitDude = function() {

	var elements = document.getElementsByTagName('input');

	for (var e = 0, l = elements.length; e < l; e++) {
		var element = elements[e],
			val = Math.round(Math.random() * 5);

		element.value = val;
		Sequencer.update(element.getAttribute('data-x'), element.getAttribute('data-y'), val, element);

	}

};


var Sequencer = {},
	DubStep = {};
(function() {

	var table = document.getElementById('timeline'),
		initialRows = 6,
		initialColumns = 10;
    
	/* The Sequencer with the spritemap first, will be reused... */
	Sequencer.spritemap = {
		'1': { 'start': 0.00, 'end': 3.50 },
		'2': { 'start': 4.00, 'end': 7.50 },
		'3': { 'start': 8.00, 'end': 11.50 },
		'4': { 'start': 12.00, 'end': 15.50 },
		'5': { 'start': 16.00, 'end': 19.50 }
	};
     

	/*
	 * Prepare our SpriteMaps
	 */
	var spritemaps = [],
		audioFiles = {
			0: 'Bass',
			1: 'Synth',
			2: 'Organ'
		},
		audioExtensions = [ 'ac3', 'm4a', 'mp3', 'ogg' ];

	for (var audioFileId in audioFiles) {

		var spriteEntry = {
			description: audioFiles[audioFileId],
			autoplay: false
		};

		spriteEntry.spritemap = Sequencer.spritemap;

		spriteEntry.resources = [];

		for (var a = 0, l = audioExtensions.length; a < l; a++) {
			spriteEntry.resources.push('dubstep-' + spriteEntry.description.toLowerCase() + '.' + audioExtensions[a]);
		}

		spritemaps.push(spriteEntry);
	}

	/*
	 * Initialize our JukeBox instances
	 */
	for (var id = 0, l = spritemaps.length; id < l; id++) {
		DubStep[id] = new JukeBox(spritemaps[id]);
	}


	// FIXME: HACK that there can't be more channels than available JukeBoxes
	initialRows = spritemaps.length;

	for (var y = 0; y < initialRows; y++) {
		var tr = document.createElement('tr');
		tr.className = 'y' + y;

		var channelDesc = document.createElement('td');
		channelDesc.innerHTML = spritemaps[y].description;
		tr.appendChild(channelDesc);

		for (var x = 0; x < initialColumns; x++) {

			var td = document.createElement('td');
			td.className = 'x' + x;

			var input = document.createElement('input');
			input.setAttribute('data-x', x);
			input.setAttribute('data-y', y);

			(function(x,y){
				input.onblur = function() {
					Sequencer.update(x, y, this.value, this);
				};
			})(x,y);

			td.appendChild(input);
			tr.appendChild(td);

		}

		table.appendChild(tr);

	}


	




	Sequencer.timeline = {};
	for (var y = 0; y < initialRows; y++) {
		Sequencer.timeline[y] = {};
	}

	Sequencer.__playbackLength = initialColumns * 4000;

	Sequencer.update = function(x, y, val, ref) {
		
		if (this.spritemap[val] === undefined) {
			val = undefined;
			ref.value = '';
		}

		this.timeline[y][x] = val;

	};


	Sequencer.generate = function() {

		var timelineActions = [];

		for (var y in this.timeline) {
		
			for (var x in this.timeline[y]) {

				var when = parseInt(x, 10) * 4000,
					what = this.timeline[y][x];

				timelineActions.push({
					channel: y,
					when: when,
					what: what
				});
			
			}

		}


		this.__timelineActions = timelineActions;

	};


	Sequencer.play = function() {

		if (!this.__timelineActions) {
			this.generate();
		}

		var started = Date.now ? Date.now() : +new Date();

		var that = this;
		this.__intervalId = window.setInterval(function() {

			var now = (Date.now ? Date.now() : +new Date()),
				current = (now - started) % that.__playbackLength,
				currentX = Math.floor(current / 4000);
			
			var elements = document.querySelectorAll('td.x' + currentX);
			for (var e = 0, el = elements.length; e < el; e++) {
				var element = elements[e];
				element.style.backgroundColor = 'green';
			}

			for (var t = 0, l = that.__timelineActions.length; t < l; t++) {
				if (current >= that.__timelineActions[t].when && current <= (that.__timelineActions[t].when + 200)) {
					DubStep[that.__timelineActions[t].channel].play(that.__timelineActions[t].what, true);
				}
			}


		}, 50);

		// Cleanup
		window.setTimeout(function() {

			window.clearInterval(that.__intervalId);
			that.__intervalId = null;
			that.__timelineActions = null;

			var elements = document.querySelectorAll('td');
			for (var e = 0, l = elements.length; e < l; e++) {
				elements[e].style.backgroundColor = 'none';
			}

		}, this.__playbackLength);

	
	}

})();

</script>


<script>

var playDemo;
(function() {

	// FIXME: REMOVE THIS WHEN READY
	return;

	var cajons = new JukeBox({

		// optional, required for MSIE-Environments =/
		// enforceFlash: true,
		
		resources: [
			'media/spritemap-cajon.ac3',
			'media/spritemap-cajon.mp3',
			'media/spritemap-cajon.m4a',
			'media/spritemap-cajon.ogg'
		],

		spritemap: {

			"cajon-1": {
				"start": 0.00,
				"end": 4.20
			},

			"cajon-2": {
				"start": 5.00,
				"end": 9.30 // wanna repeat? 4.1 sounds better than 4.3 seconds
			},

		}

	});

	var arpeggios = new JukeBox({
	
		resources: [
			'media/spritemap-arpeggios.ac3',
			'media/spritemap-arpeggios.mp3',
			'media/spritemap-arpeggios.m4a',
			'media/spritemap-arpeggios.ogg'
		],

		spritemap: {
		
			'arpeggio-1': {
				'start': 0.00,
				'end': 10.70
			},

			'arpeggio-2': {
				'start': 11.00,
				'end': 21.70
			},

			'arpeggio-3': {
				'start': 22.00,
				'end': 32.70
			}

		}

	})


	/*
	 * Below are the actions that are timed via millisecond pointers
	 * inside the whole demo timerange. The demo will go from 0 to 40000ms.
	 * Sorry for bad music, but I'm not a musician and I'm not a compositor =D
	 */
	var timelineActions = [{
		at: 0,
		exec: function() {
			cajons.play('cajon-1', true);
		}
	}, {
		at: 4200,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 4100,
		exec: function() {
			arpeggios.play('arpeggio-1', true);
		}
	}, {
		at: 15100,
		exec: function() {
			arpeggios.play('arpeggio-2', true);
		}
	}, {
		at: 15300,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 15300 + 4100,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 15300 + 2 * 4100,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 15300 + 3 * 4100,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 15300 + 4 * 4100,
		exec: function() {
			cajons.play('cajon-2', true);
		}
	}, {
		at: 27950,
		exec: function() {
			arpeggios.play('arpeggio-3', true);
		}
	}];


	var demoLengthInSeconds = 40;

	playDemo = (function(){

		/*
		 * This is all required for the UI stuff
		 */
		var markers = {
			timeline: document.getElementById('timeline-marker'),
			cajons: document.getElementById('cajons-marker'),
			arpeggios: document.getElementById('arpeggios-marker')
		};

		var currentTime = { timeline: 0, cajons: 0, arpeggios: 0 };
		var markerPercentage = { timeline: 0, cajons: 0, arpeggios: 0 };


		var intervalId = null, started, now;

		return function() {
		
			if (!intervalId) {

				started = (Date.now ? Date.now() : +new Date());

				intervalId = window.setInterval(function() {

					var now = (Date.now ? Date.now() : +new Date()),
						current = (now - started) % (demoLengthInSeconds * 1000);

					/* UI STUFF START */
					currentTime.timeline = current / 1000;
					currentTime.cajons = cajons.getCurrentTime();
					currentTime.arpeggios = arpeggios.getCurrentTime();

					markerPercentage.timeline = Math.round(currentTime.timeline / demoLengthInSeconds * 100);
					markerPercentage.cajons = Math.round(currentTime.cajons / 9.3 * 100);
					markerPercentage.arpeggios = Math.round(currentTime.arpeggios / 32.70 * 100);

					markers.timeline.innerText = currentTime.timeline.toString().substr(0,4);
					markers.cajons.innerText = currentTime.cajons.toString().substr(0,4);
					markers.arpeggios.innerText = currentTime.arpeggios.toString().substr(0,4);

					markers.timeline.style.left = markerPercentage.timeline + '%';
					markers.cajons.style.left = markerPercentage.cajons + '%';
					markers.arpeggios.style.left = markerPercentage.arpeggios + '%';
					/* UI STUFF END */


					/*
					 * This will start the playback of different sound sprite entries
					 * for the "timed" action in the timeline.
					 *
					 * Note that current is modulo, so it's between 0 and 40*1000 (ms)
					 */
					for (var t = 0, l = timelineActions.length; t < l; t++) {
						if (current >= timelineActions[t].at && current <= (timelineActions[t].at + 200)) {
							timelineActions[t].exec();
						}
					
					}

				}, 50);
			}
		
		};
	
	})();

})();
</script>
</body>
</html>
