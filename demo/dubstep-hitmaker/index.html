<!doctype html>
<html>
<head>
	<title>Zynga's JukeBox - Sequencing Demo</title>
    <meta charset="utf-8" />
	<script src="../../src/JukeBox.js"></script>

	<style>
	td {
		margin: 5px 10px;
		padding: 3px 4px;
		border: 1px dotted #ccc;
	}
	td, td.active {
		background-color: #fff;
		-webkit-transition-property: 'background-color';
		-webkit-transition-timing-function: ease-out;
		-webkit-transition-duration: 1s;
	}
	td.active {
		background-color: #0f0;
	}
	input {
		width: 2em;
	}

	</style>
</head>
<body>

<h3>DUBSTEP HIT MAKER</h3>
<span>A simple sequencing demo using Zynga's JukeBox.</span>
<br>
<span>
	This demo is using sound samples from <a href="http://www.musicradar.com/news/tech/free-music-samples-download-loops-hits-and-multis-217833/79">this site</a>.
</span>
<br>
<br>

<button onclick="Sequencer.play()">Play</button>
<button onclick="GenerateAHitDude()">Generate A Hit, Dude!</button>
<hr>

<table id="timeline"></table>


<script>


var GenerateAHitDude = function() {

	var elements = document.getElementsByTagName('input');

	for (var e = 0, l = elements.length; e < l; e++) {
		var element = elements[e],
			val = Math.round(Math.random() * 5);

		element.value = val;
		Sequencer.update(element.getAttribute('data-x'), element.getAttribute('data-y'), val, element);

	}

};


var Sequencer = {},
	DubStep = {};
(function() {

	var table = document.getElementById('timeline'),
		initialRows = 6,
		initialColumns = 10;
    
	/* The Sequencer with the spritemap first, will be reused... */
	Sequencer.spritemap = {
		'1': { 'start': 0.00, 'end': 3.50 },
		'2': { 'start': 4.00, 'end': 7.50 },
		'3': { 'start': 8.00, 'end': 11.50 },
		'4': { 'start': 12.00, 'end': 15.50 },
		'5': { 'start': 16.00, 'end': 19.50 }
	};
     

	/*
	 * Prepare our SpriteMaps
	 */
	var spritemaps = [],
		audioFiles = {
			0: 'Bass',
			1: 'Beat',
			2: 'Synth',
			3: 'Organ'
		},
		audioExtensions = [ 'ac3', 'm4a', 'mp3', 'ogg' ];

	for (var audioFileId in audioFiles) {

		var spriteEntry = {
			description: audioFiles[audioFileId],
			autoplay: false
		};

		spriteEntry.spritemap = Sequencer.spritemap;

		spriteEntry.resources = [];

		for (var a = 0, l = audioExtensions.length; a < l; a++) {
			spriteEntry.resources.push('dubstep-' + spriteEntry.description.toLowerCase() + '.' + audioExtensions[a]);
		}

		spritemaps.push(spriteEntry);
	}

	/*
	 * Initialize our JukeBox instances
	 */
	for (var id = 0, l = spritemaps.length; id < l; id++) {
		DubStep[id] = new JukeBox(spritemaps[id]);
	}



	// FIXME: HACK that there can't be more channels than available JukeBoxes
	initialRows = spritemaps.length;

	for (var y = 0; y < initialRows; y++) {
		var tr = document.createElement('tr');
		tr.className = 'y' + y;

		var channelDesc = document.createElement('td');
		channelDesc.innerHTML = spritemaps[y].description;
		tr.appendChild(channelDesc);

		for (var x = 0; x < initialColumns; x++) {

			var td = document.createElement('td');
			td.className = 'x' + x;

			var input = document.createElement('input');
			input.setAttribute('data-x', x);
			input.setAttribute('data-y', y);

			(function(x,y){
				input.onblur = function() {
					Sequencer.update(x, y, this.value, this);
				};
			})(x,y);

			td.appendChild(input);
			tr.appendChild(td);

		}

		table.appendChild(tr);

	}

	




	Sequencer.timeline = {};
	for (var y = 0; y < initialRows; y++) {
		Sequencer.timeline[y] = {};
	}

	Sequencer.__playbackLength = initialColumns * 4000;

	Sequencer.update = function(x, y, val, ref) {
		
		if (this.spritemap[val] === undefined) {
			val = undefined;
			ref.value = '';
		}

		this.timeline[y][x] = val;

	};


	Sequencer.generate = function() {

		var timelineActions = [];

		for (var y in this.timeline) {
		
			for (var x in this.timeline[y]) {

				var when = parseInt(x, 10) * 4000,
					what = this.timeline[y][x];

				timelineActions.push({
					channel: y,
					when: when,
					what: what
				});
			
			}

		}

		this.__timelineActions = timelineActions;

	};


	Sequencer.play = function() {

		if (!this.__timelineActions) {
			this.generate();
		}
		
		if (!this.__timelineActions.length) {
			// Nothing to do, dude. Why playing silence then?
			return false;
		}


		var started = Date.now ? Date.now() : +new Date(),
			that = this;

		this.__intervalId = window.setInterval(function() {

			var now = (Date.now ? Date.now() : +new Date()),
				current = (now - started) % that.__playbackLength,
				currentX = Math.floor(current / 4000);
			
			var oldElements = document.querySelectorAll('td'),
				newElements = document.querySelectorAll('td.x' + currentX);

			for (var o = 0, ol = oldElements.length; o < ol; o++) {
				oldElements[o].className = oldElements[o].className.replace(/\sactive/,'');
			}
			for (var e = 0, el = newElements.length; e < el; e++) {
				newElements[e].className += ' active';
			}

			for (var t = 0, l = that.__timelineActions.length; t < l; t++) {
				if (current >= that.__timelineActions[t].when && current <= (that.__timelineActions[t].when + 200)) {
					DubStep[that.__timelineActions[t].channel].play(that.__timelineActions[t].what, true);
				}
			}


		}, 50);

		// Cleanup
		window.setTimeout(function() {

			window.clearInterval(that.__intervalId);
			that.__intervalId = null;
			that.__timelineActions = null;

			var elements = document.querySelectorAll('td');
			for (var e = 0, l = elements.length; e < l; e++) {
				elements[e].style.backgroundColor = 'none';
			}

		}, this.__playbackLength);

	}

})();

</script>
</body>
</html>
